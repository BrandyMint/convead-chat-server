convead-chat-server
===================

Faye chat server for Convead.com
================================

Общий сервисный канал `/service/*`
--------------------------------------

Устанавливается у дежурного менеджера в целях получения сообщений об установлении conversation со стороны пользователей.

Сервисный канал чата `/service/:visitor_id`
------------------------------------------

Предназначен для получения сообщений управляющих чатом в целом. Устанавливается со стороны пользователя сразу после получения visitor_id от logger'a. Устанавливается со стороны менеджера при попытке связаться с конкретным пользователем, либо у дежурного менеджера при инициации conversation со стороны пользователя.

### Сообщения

* `entity: 'conversation', conversation: Conversation.as_json` - уведомление об текущем открытом Conversation с данным пользователем. При обработке данного сообщения устанавливается conversation канал для приемки непосредственно сообщений чата.

Канал чата `/conversations/:conversation_id`
------------------------------------------------

Устанавливаеся с обеих сторон как результат успешного открытия Conversation. Предназначен для получения непосредственно сообщений чата.

### Сообщения

* `message` - пришло сообщение.

Канал уведомлений `/notifications/:visitor_id`
---------------------------------------------

### Сообщения

* `notification` - пришло уведомление

Server API
==========

### `/chat/service/:visitor_id` Запрос на создание нового или получение уже открытого Conversation

При получении POST запроса с параметром <tt>sender (описывает пользователя или менеджера сделавшего запрос)<tt>:
  если существует открытый conversation:
    если запрос сделал пользователь то посылается сообщение <tt>conversation<tt> в сервисный канал <tt>/service/:visitor_id</tt>
    если запрос сделал менеджер то проверяется является ли он контрагентом по conversation
      если является то посылается сообщение <tt>conversation<tt> в сервисный канал <tt>/service/:visitor_id</tt>
      иначе возвращается ошибка с сообщением что чат уже открыт с другим менеджером

  если открытого запроса не существует:
    выбирается текущий дежурный менеджер организации
      если таких нет, то возвращается ошибка с сообщением <tt>chat_offline_message<tt>
      иначе создается новый Conversation и в канал <tt>/service/:visitor_id<tt> отправляется соответствующее сообщение <tt>conversation<tt>

### `/chat/conversation/:conversation_id` Запрос на создание нового сообщения в рамках текущего Conversation

При получении POST запроса с параметрами <tt>sender<tt>, <tt>content<tt> создается соответствующее сообщение и направляется уведомление <tt>message<tt> в канал <tt>/conversations/:conversation_id<tt>

### `/chat/conversation/:conversation_id/messages` Запрос на получение истории сообщений текущего пользователя (visitor из Conversation.find :conversation_id)

При получении POST запроса с необязательными параметрами <tt>count<tt>, <tt>since_id<tt> в ответе возвращается <tt>count<tt> сообщений (если параметр указан, иначе Settings.api.max_messages_count) из истории начиная с сообщения с <tt>id = since_id<tt> (если параметр указан, иначе с последнего имеющегося)

### `/chat/conversation/:conversation_id/message/:message_id/mark_read` Запрос на установку аттрибута прочитанности сообщения

При получении POST запроса без параметров у сообщения с <tt>id = :message_id<tt> аттрибут прочитанности выставляется в истину


Процедура инициализации чата
============================

* Пользователь заходит на сайт с установленным виджетом
* Виджет получает visitor_id от logger'a
* Виджет подписывается на канал `/service/:visitor_id`
* При открытии окна чата пользователем посылается запрос на `/chat/service/:visitor_id`
* В случае успешного создания `conversation` сервер отправляет в канал `/service/:visitor_id` уведомление о создании `conversation`
* Виджет получает `conversation` по сервисному каналу и подписывается на канал `/conversations/:conversation_id`
* Дежурный менеджер подписанный на общий сервисный канал `/service/*` получает `conversation` и если он выбран контрагентом то у него открывается оно чата и он также подписывается на канал `/conversations/:conversation_id`
